# Stakater Reloader Controller Deployment
apiVersion: v1
kind: Namespace
metadata:
  name: reloader-test
  labels:
    app: reloader
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: reloader
  namespace: reloader-test
  labels:
    app: reloader
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: reloader
  labels:
    app: reloader
rules:
  # Core resources the controller needs
  - apiGroups: [""]
    resources:
      - pods
      - services
      - endpoints
      - configmaps
      - secrets
      - events
      - namespaces
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
    verbs: ["get", "list", "watch", "update", "patch"]
  # Leader election
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: reloader
  labels:
    app: reloader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: reloader
subjects:
  - kind: ServiceAccount
    name: reloader
    namespace: reloader-test
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reloader
  namespace: reloader-test
  labels:
    app: reloader
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reloader
  template:
    metadata:
      labels:
        app: reloader
    spec:
      serviceAccountName: reloader
      containers:
      - name: reloader
        image: cleanstart/stakater-reloader:latest-dev
        imagePullPolicy: IfNotPresent
        # Reloader will use default configuration
        # It watches all namespaces by default and uses annotation-based reload strategy
        env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        # Relax security context to avoid permission issues
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
---
# Test Web Application - ConfigMap with application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-app-config
  namespace: reloader-test
  labels:
    app: web-app
data:
  APP_TITLE: "Stakater Reloader Demo"
  APP_COLOR: "#667eea"
  SITE_NAME: "Reloader Test Site"
---
# Test Web Application - Secret with environment variables
apiVersion: v1
kind: Secret
metadata:
  name: web-app-secret
  namespace: reloader-test
  labels:
    app: web-app
type: Opaque
stringData:
  APP_NAME: "Stakater Reloader Demo"
  ENV: "production"
  VERSION: "1.0.0"
  MESSAGE: "Welcome to Stakater Reloader! Change the ConfigMap or Secret to see automatic reload."
---
# Test Web Application Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
  namespace: reloader-test
  labels:
    app: web-app
  annotations:
    # Enable reloader to watch for ConfigMap and Secret changes
    reloader.stakater.com/auto: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: web-server
        image: python:3.11-alpine
        ports:
        - containerPort: 8000
          name: http
          protocol: TCP
        command: ["/bin/sh"]
        args:
        - -c
        - |
          mkdir -p /tmp/app && cd /tmp/app
          cat > server.py << 'EOF'
          import os
          import http.server
          import socketserver
          from datetime import datetime
          
          PORT = 8000
          
          class MyHandler(http.server.SimpleHTTPRequestHandler):
              def do_GET(self):
                  if self.path == '/' or self.path == '/index.html':
                      self.send_response(200)
                      self.send_header('Content-type', 'text/html')
                      self.end_headers()
                      
                      # Read environment variables
                      app_name = os.getenv('APP_NAME', 'Unknown')
                      env = os.getenv('ENV', 'Unknown')
                      version = os.getenv('VERSION', 'Unknown')
                      message = os.getenv('MESSAGE', 'No message')
                      app_title = os.getenv('APP_TITLE', 'Stakater Reloader Test')
                      app_color = os.getenv('APP_COLOR', '#667eea')
                      site_name = os.getenv('SITE_NAME', 'Reloader Test Site')
                      
                      # Get pod name and timestamp
                      pod_name = os.getenv('HOSTNAME', 'Unknown')
                      timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                      
                      html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{app_title}</title>
              <style>
                  body {{
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      margin: 0;
                      padding: 0;
                      background: linear-gradient(135deg, {app_color} 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                  }}
                  .container {{
                      background: white;
                      border-radius: 20px;
                      padding: 40px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      max-width: 900px;
                      width: 90%;
                      margin: 20px;
                  }}
                  h1 {{
                      color: #333;
                      margin-top: 0;
                      border-bottom: 3px solid {app_color};
                      padding-bottom: 15px;
                  }}
                  .info-box {{
                      background: #f8f9fa;
                      border-left: 4px solid {app_color};
                      padding: 20px;
                      margin: 20px 0;
                      border-radius: 5px;
                  }}
                  .config-value {{
                      font-size: 1.2em;
                      color: #764ba2;
                      font-weight: bold;
                      margin: 10px 0;
                      padding: 8px;
                      background: white;
                      border-radius: 5px;
                  }}
                  .timestamp {{
                      color: #666;
                      font-size: 0.9em;
                      margin-top: 10px;
                  }}
                  .status {{
                      display: inline-block;
                      padding: 8px 20px;
                      background: #28a745;
                      color: white;
                      border-radius: 20px;
                      font-size: 0.9em;
                      margin-top: 10px;
                  }}
                  .pod-info {{
                      background: #e9ecef;
                      padding: 10px;
                      border-radius: 5px;
                      margin-top: 10px;
                      font-family: monospace;
                      font-size: 0.9em;
                  }}
                  code {{
                      background: #f1f3f5;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: 'Courier New', monospace;
                  }}
                  ol {{
                      line-height: 1.8;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸš€ {app_title}</h1>
                  <div class="info-box">
                      <h2>Application Configuration</h2>
                      <div class="config-value">App Name: {app_name}</div>
                      <div class="config-value">Environment: {env}</div>
                      <div class="config-value">Version: {version}</div>
                      <div class="config-value">Message: {message}</div>
                      <div class="config-value">Site Name: {site_name}</div>
                      <div class="config-value">Theme Color: {app_color}</div>
                  </div>
                  <div class="info-box">
                      <h2>Pod Information</h2>
                      <div class="pod-info">
                          Pod Name: {pod_name}<br>
                          Current Time: {timestamp}
                      </div>
                  </div>
                  <div class="info-box">
                      <h2>How to Test Reloader</h2>
                      <ol>
                          <li>Update the ConfigMap: <code>kubectl edit configmap web-app-config -n reloader-test</code>
                              <ul>
                                  <li>Change APP_TITLE, APP_COLOR, or SITE_NAME</li>
                              </ul>
                          </li>
                          <li>Or update the Secret: <code>kubectl edit secret web-app-secret -n reloader-test</code>
                              <ul>
                                  <li>Change APP_NAME, ENV, VERSION, or MESSAGE</li>
                                  <li>Note: Secrets are base64 encoded, use <code>kubectl create secret</code> or encode values</li>
                              </ul>
                          </li>
                          <li>Save and exit</li>
                          <li>Reloader will automatically detect the change and restart the pod</li>
                          <li>Wait a few seconds, then refresh this page to see the updated configuration</li>
                          <li>Check pod restart: <code>kubectl get pods -n reloader-test -w</code></li>
                      </ol>
                  </div>
                  <div class="timestamp">
                      Page loaded at: {timestamp}
                  </div>
                  <div class="status">âœ… Application Running</div>
              </div>
          </body>
          </html>"""
                      self.wfile.write(html.encode())
                  else:
                      self.send_response(404)
                      self.end_headers()
          
          with socketserver.TCPServer(("", PORT), MyHandler) as httpd:
              print(f"Server started at http://0.0.0.0:{PORT}")
              httpd.serve_forever()
          EOF
          python server.py
        env:
        - name: APP_NAME
          valueFrom:
            secretKeyRef:
              name: web-app-secret
              key: APP_NAME
        - name: ENV
          valueFrom:
            secretKeyRef:
              name: web-app-secret
              key: ENV
        - name: VERSION
          valueFrom:
            secretKeyRef:
              name: web-app-secret
              key: VERSION
        - name: MESSAGE
          valueFrom:
            secretKeyRef:
              name: web-app-secret
              key: MESSAGE
        - name: APP_TITLE
          valueFrom:
            configMapKeyRef:
              name: web-app-config
              key: APP_TITLE
        - name: APP_COLOR
          valueFrom:
            configMapKeyRef:
              name: web-app-config
              key: APP_COLOR
        - name: SITE_NAME
          valueFrom:
            configMapKeyRef:
              name: web-app-config
              key: SITE_NAME
        resources:
          requests:
            cpu: "50m"
            memory: "64Mi"
          limits:
            cpu: "200m"
            memory: "128Mi"
        livenessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
---
# Service to expose the web application
apiVersion: v1
kind: Service
metadata:
  name: web-app
  namespace: reloader-test
  labels:
    app: web-app
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8000
    protocol: TCP
    name: http
  selector:
    app: web-app
---
# Ingress to access the web app (optional - uncomment if you have an ingress controller)
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: web-app-ingress
#   namespace: reloader-test
#   labels:
#     app: web-app
# spec:
#   rules:
#   - host: reloader-test.local
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: web-app
#             port:
#               number: 80

